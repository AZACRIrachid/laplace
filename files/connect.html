<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Laplace</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        #header {
            padding: 20px;
            font-weight: bold;
        }
        #header-room {
            padding: 20px;
            font-weight: bold;
        }
        #video-wrapper {
            text-align: center;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        #remoteVideo {
            max-width: 95vw;
            max-height: 80vh;
            box-shadow: 0 10px 25px 0 rgba(0,0,0,0.50);
        }
        #output {
            max-width: 100vw;
            padding: 20px;
            overflow: scroll;
            font-size: 10px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="header" class="float-left">Laplace Connect</div>
    <div id="header-room" class="float-right"># {{.SessionID}}</div>
    <div id="header"></div>

    <div id="video-wrapper">
        <video id="remoteVideo" autoplay playsinline controls>
        </video>
    </div>

    <pre id="output"></pre>

    <script>
        let pc;
        let mediaStream;
        let sessionID;

        // noinspection JSAnnotator
        const id = {{.SessionID}};
        const socket = new WebSocket("{{.Url}}?id=" + id);

        socket.onmessage = async function (e) {
            output.innerHTML += "[+] " + e.data;
            try {
                const jsonData = JSON.parse(e.data);
                if (jsonData.Type === "newSession") {
                    await newSession(jsonData.SessionID);
                } else if (jsonData.Type === "addCallerIceCandidate") {
                    await addCallerIceCandidate(jsonData.SessionID, JSON.parse(jsonData.Value));
                } else if (jsonData.Type === "gotOffer") {
                    await gotOffer(jsonData.SessionID, JSON.parse(jsonData.Value));
                }
            } catch (e) {
                console.error(e)
            }
        };

        socket.onopen = async function () {
            output.innerHTML += "[-] Status: Connected\n";
            await initMedia();
        };

        async function initMedia() {
            console.log('initMedia');
            mediaStream = new MediaStream();
            const remoteVideoElement = document.querySelector('video#remoteVideo');
            remoteVideoElement.srcObject = mediaStream;
        }

        async function newSession(sID) {
            console.log('newSession', sID);
            sessionID = sID;
            const iceConfig = {
                iceServers: [{
                    urls: [
                        // 'stun:stun1.l.google.com:19302',
                        // 'stun:stun2.l.google.com:19302',
                    ],
                }],
                iceCandidatePoolSize: 10,
            };
            pc = new RTCPeerConnection(iceConfig);
            pc.onicecandidate = e => {
                console.log('pc.onicecandidate', e);
                if (!e.candidate) {
                    console.log('pc.onicecandidate', 'got final candidate!');
                    return;
                }
                socket.send(JSON.stringify({
                    Type: "addCalleeIceCandidate",
                    SessionID: sessionID,
                    Value: JSON.stringify(e.candidate),
                }))
            };
            pc.oniceconnectionstatechange = () => {
                console.log('pc.oniceconnectionstatechange', pc.iceConnectionState);
                if (pc.iceConnectionState === 'disconnected') {
                    output.innerHTML += "[-] Disconnected with Peer\n";
                    console.log('Disconnected');
                    pc.close();
                    pc = null;
                }
            };
            pc.ontrack = event => {
                console.log('pc.ontrack', event);
                event.streams[0].getTracks().forEach(track => {
                    mediaStream.addTrack(track)
                });
                const remoteVideoElement = document.querySelector('video#remoteVideo');
                remoteVideoElement.play();
            }
        }

        async function addCallerIceCandidate(sID, v) {
            console.log('addCallerIceCandidate', sID, v);
            if (sessionID !== sID) return;
            return pc.addIceCandidate(v);
        }

        async function gotOffer(sID, v) {
            console.log('gotOffer', sID, v);
            if (sessionID !== sID) return;
            await pc.setRemoteDescription(new RTCSessionDescription(v));
            const answer = await pc.createAnswer()
            console.log('pc.createAnswer', answer);
            await pc.setLocalDescription(answer);
            socket.send(JSON.stringify({
                Type: "gotAnswer",
                SessionID: sessionID,
                Value: JSON.stringify(answer),
            }))
        }
    </script>
</body>
</html>